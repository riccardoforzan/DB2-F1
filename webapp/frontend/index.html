<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT"
            crossorigin="anonymous"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
        <title>F1 stats</title>
    </head>

    <body>
        <h1 class="text-center mt-3">F1 stats</h1>
        <div class="container mt-5">
            <div class="row">
                <div class="row">
                    <div class="form-group">
                        <label for="driverSelect" class="">Driver</label>
                        <select
                            id="driverSelect"
                            name="lang"
                            class="form-control selectpicker"
                            data-live-search="true"
                        >
                            <!-- Default option -->
                            <option value="" selected disabled hidden></option>
                        </select>
                    </div>
                </div>
            </div>
            <h1 class="text-center mt-3">Driver Stats</h1>
            <div class="container mt-5">
                <div class="row">
                    <div class="col-md-3 m-2">
                        <div class="card" style="width: 18rem">
                            <div class="card-body">
                                <h5 class="card-title" id="driverChampionships">
                                    10
                                </h5>
                                <p class="card-text">Driver Championships</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 m-2">
                        <div class="card" style="width: 18rem">
                            <div class="card-body">
                                <h5 class="card-title" id="seasons">10</h5>
                                <p class="card-text">Seasons</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 m-2">
                        <div class="card" style="width: 18rem">
                            <div class="card-body">
                                <h5 class="card-title" id="races">10</h5>
                                <p class="card-text">Races</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-2 m-2">
                        <div class="card" style="width: 18rem">
                            <div class="card-body">
                                <h5 class="card-title" id="pole">10</h5>
                                <p class="card-text">Polepositions</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 m-2">
                        <div class="card" style="width: 18rem; height: 12rem">
                            <div class="card-body">
                                <h5 class="card-title" id="victories">10</h5>
                                <p class="card-text">Race Victories</p>
                                <h5 class="card-title" id="percVictories">
                                    10%
                                </h5>
                                <p class="card-text">
                                    Percentage of Victories to the toal number
                                    of races
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 m-2">
                        <div class="card" style="width: 18rem; height: 12rem">
                            <div class="card-body">
                                <h5 class="card-title" id="podiums">10</h5>
                                <p class="card-text">Podiums</p>
                                <h5 class="card-title" id="percPodiums">10%</h5>
                                <p class="card-text">
                                    Percentage of Podiums to the toal number of
                                    races
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 m-2">
                        <div class="card" style="width: 18rem; height: 12rem">
                            <div class="card-body">
                                <h5 class="card-title" id="bestQuali">10</h5>
                                <p class="card-text">Best Finish in qualify</p>
                                <h5 class="card-title" id="worstQuali">10</h5>
                                <p class="card-text">Worst Finish in qualify</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-2 m-2">
                        <div class="card" style="width: 18rem; height: 12rem">
                            <div class="card-body">
                                <h5 class="card-title" id="bestRace">10</h5>
                                <p class="card-text">Best Finish in Race</p>
                                <h5 class="card-title" id="worstRace">10</h5>
                                <p class="card-text">Worst Finish in Race</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 m-2">
                        <div class="card" style="width: 18rem; height: 7rem">
                            <div class="card-body">
                                <h5 class="card-title" id="q3times">10</h5>
                                <p class="card-text">Number of times in Q3</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 m-2">
                        <div class="card" style="width: 18rem; height: 7rem">
                            <div class="card-body">
                                <h5 class="card-title" id="dnf">10</h5>
                                <p class="card-text">DNF</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 m-2">
                        <div class="card" style="width: 18rem; height: 7rem">
                            <div class="card-body">
                                <h5 class="card-title" id="cleanRaces">10</h5>
                                <p class="card-text">
                                    Clean Races (started and arrived first)
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 m-2">
                        <div class="card" style="width: 18rem; height: 7rem">
                            <div class="card-body">
                                <h5 class="card-title" id="cons">
                                    Mercedes, McLaren
                                </h5>
                                <p class="card-text">
                                    Constructors for which he drove
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 m-2">
                        <div class="card" style="width: 18rem; height: 7rem">
                            <div class="card-body">
                                <h5 class="card-title" id="consWin">
                                    Mercedes, McLaren
                                </h5>
                                <p class="card-text">
                                    Constructors for which he won a race
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <h1 class="text-center mt-3">Charts</h1>
            <div class="container mt-5 mb-5">
                <canvas
                    id="pointCpYear"
                    style="
                        display: inline-block;
                        margin-left: 2 em;
                        width: 100%;
                        max-width: 600px;
                    "
                ></canvas>
                <canvas
                    id="positionCpYear"
                    style="display: inline-block; width: 100%; max-width: 600px"
                ></canvas>
                <canvas
                    id="top10year"
                    style="
                        display: inline-block;
                        margin-left: 2 em;
                        width: 100%;
                        max-width: 600px;
                    "
                ></canvas>
                <canvas
                    id="top5year"
                    style="display: inline-block; width: 100%; max-width: 600px"
                ></canvas>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

        <script>
            const driverSelect = $("#driverSelect");

            //Load all the drivers from the API
            const url = "http://127.0.0.1:8000/drivers";
            fetch(url)
                .then((response) => response.json())
                .then((data) => {
                    data.forEach(function (item) {
                        const uri = item.driver.value;
                        const name = item.name.value;
                        driverSelect.append(
                            `<option value="${uri}">${name}</option>`
                        );
                    });
                    driverSelect.selectpicker("refresh");
                });

            driverSelect.on("change", function () {
                const driverId = ($(this).val().split("#")[1]).replace('driver','');
                console.log(driverId);
                fetchStats(driverId);
                fetchCharts(driverId);
            });

            function fetchStats(driverId) {
                const d_champ = $("#driverChampionships");
                const seasons = $("#seasons");
                const races = $("#races");
                const pol = $("#pol");
                const victories = $("#victories");
                const percVictories = $("#percVictories");
                const podiums = $("#podiums");
                const percPodiums = $("#percPodiums");
                const bestQuali = $("#bestQuali");
                const worstQuali = $("#worstQuali");
                const bestRace = $("#bestRace");
                const worstRace = $("#worstRace");
                const q3times = $("#q3times");
                const dnf = $("#dnf");
                const cleanRaces = $("#cleanRaces");
                const cons = $("#cons");
                const consWin = $("#consWin");
                const cards = [
                    d_champ,
                    cons,
                    consWin,
                    seasons,
                    races,
                    pol,
                    victories,
                    percVictories,
                    podiums,
                    percPodiums,
                    bestQuali,
                    worstQuali,
                    bestRace,
                    worstRace,
                    q3times,
                    dnf,
                    cleanRaces,
                ];
                fetch(url + "/" + driverId + "/stats")
                    .then((response) => response.json())
                    .then((data) => {
                        //console.log(data);
                        //const wins = data.cp_win;
                        //d_champ.text(wins);
                        var i = 0;
                        const param = [
                            "cp_win",
                            "constructor",
                            "constructor_win",
                            "season_number",
                            "races_number",
                            "pole_number",
                            "victories_number",
                            "perc_vic_races",
                            "podiums",
                            "perc_pod_races",
                            "best_quali",
                            "worst_quali",
                            "best_race",
                            "worst_race",
                            "q3_quali",
                            "dnf",
                            "victory_from_pole"
                        ];
                        data["perc_vic_races"] =
                            parseFloat(data["perc_vic_races"]).toFixed(2) + "%";
                        data["perc_pod_races"] =
                            parseFloat(data["perc_pod_races"]).toFixed(2) + "%";
                        param.forEach(function (el) {
                            console.log(data[el]);
                            cards[i++].text(data[el]);
                        });
                    });
            }
        </script>

        <script>
            function fetchCharts(driverId) {
                fetch(url + "/" + driverId + "/charts")
                        .then((response) => response.json())
                        .then((data) => {
                                
                            var xValues = Object.keys(data["driver_championship_points_year_by_year"])

                            var yValues = Object.values(data["driver_championship_points_year_by_year"])
                            var barColors = ["black "];

                            new Chart("pointCpYear", {
                                type: "bar",
                                data: {
                                    labels: xValues,
                                    datasets: [
                                        {
                                            backgroundColor: barColors,
                                            data: yValues,
                                        },
                                    ],
                                },
                                options: {
                                    legend: { display: false },
                                    title: {
                                        display: true,
                                        text: "Points year per year in the Driver Championship",
                                    },
                                },
                            });

                            
                            var xValues = Object.keys(data["driver_championship_positions_year_by_year"])

                            var yValues = Object.values(data["driver_championship_positions_year_by_year"])
                            var barColors = ["black "];

                            new Chart("positionCpYear", {
                                type: "bar",
                                data: {
                                    labels: xValues,
                                    datasets: [
                                        {
                                            backgroundColor: barColors,
                                            data: yValues,
                                        },
                                    ],
                                },
                                options: {
                                    legend: { display: false },
                                    title: {
                                        display: true,
                                        text: "Position year per year in the Driver Championship",
                                    },
                                },
                            });

                            
                            var xValues = Object.keys(data["get_top_ten_position_by_year"])

                            var yValues = Object.values(data["get_top_ten_position_by_year"])
                            var barColors = ["black "];

                            new Chart("top10year", {
                                type: "bar",
                                data: {
                                    labels: xValues,
                                    datasets: [
                                        {
                                            backgroundColor: barColors,
                                            data: yValues,
                                        },
                                    ],
                                },
                                options: {
                                    legend: { display: false },
                                    title: {
                                        display: true,
                                        text: "Top 10 race finishes year per year",
                                    },
                                },
                            });

                            var xValues = Object.keys(data["get_top_five_position_by_year"])

                            var yValues = Object.values(data["get_top_five_position_by_year"])
                            var barColors = ["black "];
                            new Chart("top5year", {
                                type: "bar",
                                data: {
                                    labels: xValues,
                                    datasets: [
                                        {
                                            backgroundColor: barColors,
                                            data: yValues,
                                        },
                                    ],
                                },
                                options: {
                                    legend: { display: false },
                                    title: {
                                        display: true,
                                        text: "Top 5 race finishes year per year",
                                    },
                                },
                            });
                            
                        });

            
        }
        </script>
    </body>
</html>
